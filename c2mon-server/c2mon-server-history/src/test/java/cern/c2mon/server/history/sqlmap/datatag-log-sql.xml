<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN"
  "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

  <!--
    take "namespace=Mapper interface" for the mapper SQL statements to
    be picked up automatically
  -->
<mapper namespace="cern.c2mon.server.history.mapper.DataTagLogMapper">

  <!--
    Inserts a new row in the history table that represents some log
    information for a given dataTag. The values for the inserted row are
    stored in the HistoricTag object
  -->
  <insert id="insertLog" parameterType="DataTagSTLog">
    INSERT INTO SHORTTERMLOG (LOGDATE, TAGID, TAGNAME, TAGVALUE, TAGVALUEDESC,
    TAGDATATYPE,
    TAGSTATUS, TAGSTATUSDESC, TAGMODE, TAGDIR, TAGTIME, TAGDAQTIME, TAGSERVERTIME)
    VALUES (
    <!-- The logDate is not null, because is a dataTag read from the fallback file -->
    <if test="logDate != null">#{logDate,jdbcType=TIMESTAMP}</if>
    <!-- The logDate is null, what means that comes from a DAQ -->
    <if test="logDate == null">CURRENT_TIMESTAMP</if>
    ,#{tagId,jdbcType=NUMERIC},#{tagName,jdbcType=VARCHAR},#{tagValue,jdbcType=VARCHAR},#{tagValueDesc,jdbcType=VARCHAR}
    ,#{tagDataType,jdbcType=VARCHAR},#{tagQualityCode,jdbcType=NUMERIC}
    ,#{tagQualityDesc,jdbcType=VARCHAR},#{tagMode,jdbcType=NUMERIC}
    ,'I',#{sourceTimestamp,jdbcType=TIMESTAMP},
         #{daqTimestamp,jdbcType=TIMESTAMP},
         #{serverTimestamp,jdbcType=TIMESTAMP})
  </insert>

  <!-- only used to remove inserts done during testing -->
  <delete id="deleteDataTagLog" parameterType="Long">
    DELETE FROM SHORTTERMLOG WHERE tagid = #{id}
  </delete>

</mapper>
