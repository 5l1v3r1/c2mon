<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="cern.c2mon.server.cache.dbaccess.ExpressionMapper">

  <!-- result map below corresponds to the abstract ExpressionCacheObject -->
  <resultMap id="expressionResultMap" type="cern.c2mon.server.common.expression.ExpressionCacheObject">
    <id property="id" column="EX_ID" jdbcType="NUMERIC" javaType="java.lang.Long"/>
    <result property="description" column="EX_DESCRIPTION" jdbcType="VARCHAR"/>
    <result property="dataType" column="EX_DATATYPE"/>
    <result property="metadata" column="EX_METADATA" javaType="cern.c2mon.server.common.metadata.Metadata"
            jdbcType="VARCHAR"/>
    <result property="expression" column="EX_EXPRESSION" jdbcType="VARCHAR"/>
    <result property="value" column="EX_VALUE" javaType="java.lang.Object" jdbcType="VARCHAR"/>
    <result property="version" column="EX_VERSION" jdbcType="NUMERIC" javaType="java.lang.Long"/>
    <collection property="alarmIds" ofType="cern.c2mon.server.common.alarm.Alarm" javaType="java.util.ArrayList"
                column="EX_ID" select="selectAlarms"/>
  </resultMap>

  <resultMap id="alarmResultMap" type="cern.c2mon.server.common.alarm.Alarm">
    <id property="id" column="ALARMID" jdbcType="NUMERIC" javaType="java.lang.Long"/>
    <result property="faultFamily" column="ALARMFFAMILY" jdbcType="VARCHAR"/>
    <result property="faultMember" column="ALARMFMEMBER" jdbcType="VARCHAR"/>
    <result property="faultCode" column="ALARMFCODE" jdbcType="NUMERIC"/>
    <result property="state" column="ALARMSTATE" jdbcType="VARCHAR"/>
    <result property="timestamp" column="ALARMTIME" jdbcType="TIMESTAMP"/>
    <result property="published" column="ALA_PUBLISHED" jdbcType="NUMERIC"/>
    <result property="info" column="ALARMINFO" jdbcType="VARCHAR"/>
    <result property="condition" column="ALARMCONDITION" javaType="cern.c2mon.server.common.alarm.AlarmCondition"
            jdbcType="VARCHAR"/>
    <result property="dataTagId" column="ALARM_TAGID" jdbcType="NUMERIC" javaType="java.lang.Long"/>
    <result property="metadata" column="ALARMMETADATA" javaType="cern.c2mon.server.common.metadata.Metadata"
            jdbcType="VARCHAR"/>
    <association property="lastPublication" javaType="cern.c2mon.server.common.alarm.AlarmPublication">
      <result property="state" column="ALA_PUB_STATE" jdbcType="VARCHAR"/>
      <result property="publicationTime" column="ALA_PUB_TIME" jdbcType="TIMESTAMP"/>
      <result property="info" column="ALA_PUB_INFO" jdbcType="VARCHAR"/>
    </association>
  </resultMap>

  <!-- must specify jdbcType for parameters that can be null in DB  -->
  <insert id="insertExpression" parameterType="cern.c2mon.server.common.expression.ExpressionCacheObject">
    INSERT INTO DSLEXPRESSION (EX_ID, EX_DESCRIPTION, EX_DATATYPE, EX_VALUE, EX_EXPRESSION, EX_METADATA, EX_VERSION)
    VALUES (#{id}, #{description}, #{dataType}, #{value},#{expression}, #{metadata, jdbcType=VARCHAR}, #{version})
  </insert>

  <delete id="deleteExpression" parameterType="Long">
    delete from DSLEXPRESSION where EX_ID = #{id}
  </delete>

  <select id="selectAlarms" resultMap="alarmResultMap">
    SELECT * FROM ALARM WHERE ALARM_TAGID = #{id}
  </select>

  <select id="getAll" resultMap="expressionResultMap">
    Select * from DSLEXPRESSION
  </select>

  <select id="getItem" resultMap="expressionResultMap" parameterType="Long">
    SELECT * FROM DSLEXPRESSION where EX_ID = #{id}
  </select>
</mapper>